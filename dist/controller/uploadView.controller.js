sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/ColumnListItem","sap/m/Input","sap/base/util/deepExtend","sap/m/CheckBox"],function(e,t,o,s,a,i,r){"use strict";return e.extend("exceluploadproject.controller.uploadView",{onInit:function(){this._bEditMode=false;var e=new t({bEditMode:false,editButtonText:"Edit"});if(typeof XLSX==="undefined"){sap.ui.require(["sap/ui/thirdparty/jquery"],function(){$.getScript("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js")})}this.getView().setModel(e,"view");this.getView().setModel(new t({excelRows:[]}),"TableModel");var o=new t;this.getView().setModel(o,"csvModel");this.onReadCSV();this.oTable=this.byId("idCSVTable");this.oReadOnlyTemplate=this.byId("idCSVTable").getBindingInfo("items").template.clone();this.rebindTable(this.oReadOnlyTemplate,"Navigation");this.oEditableTemplate=new s({cells:[new a({value:"{csvModel>id}"}),new a({value:"{csvModel>name}",editable:"{= ${csvModel>selected} }"}),new a({value:"{csvModel>place}",editable:"{= ${csvModel>selected} }"}),new r({selected:"{csvModel>selected}"})]})},userinfo:function(){},onReadCSV:function(){var e=this.getOwnerComponent().getModel();e.read("/CsvRows",{success:function(e){this.getView().getModel("csvModel").setProperty("/csvRows",e.results)}.bind(this),error:function(e){sap.m.MessageToast.show(e.message);console.error("Error details:",e)}})},onExcelUpload:async function(e){var t=e.getParameter("files")[0];if(!t){o.show("Please choose an Excel file.");return}if(typeof XLSX==="undefined"){await new Promise((e,t)=>{$.getScript("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").done(e).fail(()=>t("Failed to load XLSX library"))})}var s=new FileReader;s.onload=function(e){var o=new Uint8Array(e.target.result);var s=XLSX.read(o,{type:"array"});var a=s.Sheets[s.SheetNames[0]];var i=XLSX.utils.sheet_to_json(a);var r=i.map(e=>Object.fromEntries(Object.entries(e).map(([e,t])=>[e.toLowerCase(),t])));var l=r.map(e=>Object.fromEntries(Object.entries(e).map(([e,t])=>[e.replace(/\s+/g,""),t])));var n=new Date;var d=n.toLocaleDateString();var c=n.toLocaleTimeString();var u=n.toISOString();l.forEach(e=>{e.uploadDate=d;e.uploadTime=c;e.uploadlogtime=u;e.fileName=t.name});var p=this.getView().getModel("TableModel");p.setProperty("/excelRows",l);p.setProperty("/uploadInfo",{fileName:t.name,fileSize:(t.size/1024).toFixed(2)+" KB",uploadedAt:u,recordCount:l.length});sap.m.MessageToast.show("Excel loaded successfully at "+c)}.bind(this);s.readAsArrayBuffer(t)},onSaveToHana:async function(){var e=this.byId("excelUploader");var t=e.oFileUpload?e.oFileUpload.files[0]:null;if(!t){sap.m.MessageToast.show("Please select a file before saving.");return}var o=this.getOwnerComponent().getModel();var s=this.getView().getModel("TableModel").getProperty("/excelRows");var a=this.getView().getModel("TableModel").getProperty("/uploadInfo/fileName");var i="subhakar";var r="Success";var l=(new Date).toISOString();var n="";var d=s.some(e=>!e.name||!e.place||e.name.trim()===""||e.place.trim()==="");if(d){r="Failure";n="Missing Name or Place in one or more rows. Upload cancelled.";sap.m.MessageToast.show("Upload failed: "+n);const e={filename:a,user:i,status:r,logtime:l.split("T")[0]};await new Promise((t,s)=>{o.create("/fileLog",e,{success:function(){t();o.refresh()},error:s})});this.getOwnerComponent().getRouter().navTo("Log");return}try{await new Promise((e,t)=>{o.callFunction("/uploadExcelData",{method:"GET",urlParameters:{data:JSON.stringify(s),fileName:a,user:i,status:r,logtime:l.split("T")[0]},success:function(t){console.log("Function success:",t);sap.m.MessageToast.show("Excel data uploaded successfully!");e();o.refresh()},error:function(e){console.error("Function error:",e);sap.m.MessageToast.show("Error uploading Excel data!");r="Failure";t(e)}})});const e={filename:a,user:i,status:r,logtime:l.split("T")[0]};await new Promise((t,s)=>{o.create("/fileLog",e,{success:function(){console.log("Log created:",e);t();o.refresh()},error:function(e){console.error("Error creating log:",e);s(e)}})});this.getOwnerComponent().getRouter().navTo("Log")}catch(e){console.error("Upload Exception:",e);sap.m.MessageToast.show("Unexpected error during upload.")}},rebindTable:function(e,t){this.oTable.bindItems({path:"csvModel>/csvRows",template:e,templateShareable:true,key:"csvModel>id"}).setKeyboardMode(t)},onEdit:function(){var e=this.getView().getModel("view");var t=this.getView().getModel("csvModel");var s=t.getProperty("/csvRows");this._bEditMode=!this._bEditMode;e.setProperty("/bEditMode",this._bEditMode);e.setProperty("/editButtonText",this._bEditMode?"Cancel Edit":"Edit");if(this._bEditMode){s.forEach(function(e){e.selected=e.name==="Ravi111"});o.show("Edit mode enabled")}else{s.forEach(function(e){e.selected=false});o.show("View mode enabled")}t.setProperty("/csvRows",s);this.aProductCollection=i([],this.getView().getModel("csvModel").getProperty("/csvRows"));this.rebindTable(this.oEditableTemplate,"Edit")},onCancel:function(){var e=this.getView().getModel("csvModel").getProperty("/csvRows");this.getView().getModel("csvModel").setProperty("/csvRows",e);this.rebindTable(this.oReadOnlyTemplate,"Navigation")},onSave:function(){var e=this.getOwnerComponent().getModel();var t=this.getView().getModel("csvModel").getProperty("/csvRows");t.forEach(function(t){var o="/CsvRows("+t.id+")";var s={name:t.name,place:t.place};e.update(o,s,{success:function(){console.log("Record "+t.id+" updated successfully")},error:function(e){console.error("Error updating record "+t.id,e);sap.m.MessageToast.show("Update failed for record "+t.id)}})});this.onReadCSV();sap.m.MessageToast.show("All records updated successfully!");this.rebindTable(this.oReadOnlyTemplate,"Navigation")}})});
//# sourceMappingURL=uploadView.controller.js.map